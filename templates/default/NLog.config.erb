<?xml version="1.0"?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <targets>
    <target name="RollingLogFileAppender" xsi:type="File" layout="${longdate}|[${level}]|R:${mdlc:item=requestId}|${callsite}|${message}|${exception:format=tostring}" fileName="${basedir}\logs\ServiceLayer.API.log" archiveFileName="${basedir}\logs\archives\ServiceLayer.API.log.{#}" archiveEvery="<%= @archiveEvery %>" archiveNumbering="Rolling" maxArchiveFiles="<%= @maxArchiveFiles %>" concurrentWrites="true" keepFileOpen="false" />
    <target name="NLogTraceAppender" xsi:type="File" layout="${longdate}|[${level}]|R:${mdlc:item=requestId}|${callsite}|${message}" fileName="${basedir}\logs\ServiceLayer.Tracing.log" archiveFileName="${basedir}\logs\archives\ServiceLayer.Tracing.log.{#}" archiveEvery="<%= @archiveEvery %>" archiveNumbering="Rolling" maxArchiveFiles="<%= @maxArchiveFiles %>" concurrentWrites="true" keepFileOpen="false" />
    <target name="HangfireAppender" xsi:type="File" layout="${longdate}|[${level}]|R:${mdlc:item=requestId}|${callsite}|${message}|${exception:format=tostring}" fileName="${basedir}\logs\FireAndForget.log" archiveFileName="${basedir}\logs\archives\FireAndForget.log.{#}" archiveEvery="<%= @archiveEvery %>" archiveNumbering="Rolling" maxArchiveFiles="<%= @maxArchiveFiles %>" concurrentWrites="true" keepFileOpen="false" />
    <target name="InterceptorAppender" xsi:type="File" layout="${longdate}|[${level}]|R:${mdlc:item=requestId}|${callsite}|${message}" fileName="${basedir}\logs\ServiceLayer.Interceptor.log" archiveFileName="${basedir}\logs\archives\ServiceLayer.Tracing.log.{#}" archiveEvery="<%= @archiveEvery %>" archiveNumbering="Rolling" maxArchiveFiles="<%= @maxArchiveFiles %>" concurrentWrites="true" keepFileOpen="false" />
    <target name="NewRelicAppender" xsi:type="MethodCall" methodName="NoticeError"
          className="ServiceLayer.Services.Notifications.NewRelicLogger, ServiceLayer.Services">
      <parameter layout="${longdate}|[${level}]|R:${mdlc:item=requestId}|${callsite}|${message}" name="message"/>
    </target>
  </targets>
  <rules>
    <logger name="Hangfire.*" minlevel="Debug" writeTo="HangfireAppender" final="true"/>
    <logger name="*" minlevel="Debug" writeTo="HangfireAppender">
      <filters>
        <when condition="starts-with('${mdlc:item=requestId}','Job')" action="LogFinal"/>
        <when condition="not starts-with('${mdlc:item=requestId}','Job')" action="Ignore"/>
      </filters>
    </logger>
    <logger name="ServiceLayer.WebApi.Infrastructure.TraceWriters.NLogTraceWriter" minlevel="<%= @minlevel %>" writeTo="NLogTraceAppender" final="true" />
    <logger name="ServiceLayer.API.Interceptors.*" minlevel="<%= @minlevel %>" writeTo="InterceptorAppender" final="true" />
    <logger name="*" minlevel="<%= @minlevel %>" writeTo="RollingLogFileAppender" />
    <logger name="*" minlevel="Warn" writeTo="NewRelicAppender" />
  </rules>
</nlog>